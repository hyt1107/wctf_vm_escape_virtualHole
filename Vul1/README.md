

# QEMU Virtio-SCSI è™›æ“¬æ©Ÿé€ƒé€¸æ¼æ´é©—è­‰ (PoC)

æœ¬å°ˆæ¡ˆåŒ…å«ä¸€å€‹ Linux Kernel Module (LKM) çš„æ¦‚å¿µé©—è­‰ç¨‹å¼ç¢¼ï¼ˆPoCï¼‰ï¼Œç”¨æ–¼æ¼”ç¤ºé‡å° QEMU `virtio-scsi` å¾Œç«¯è¨­å‚™çš„ **æ‹’çµ•æœå‹™ (DoS)** æ”»æ“Šã€‚è©²æ”»æ“Šåˆ©ç”¨äº† QEMU åœ¨è™•ç† Virtio æè¿°ç¬¦è¨˜æ†¶é«”æ˜ å°„æ™‚çš„é‚è¼¯æ¼æ´ï¼Œå°è‡´ Host ç«¯ QEMU é€²ç¨‹ç™¼ç”Ÿ **Segmentation Fault (è¨˜æ†¶é«”å€æ®µéŒ¯èª¤)** ä¸¦å´©æ½°ã€‚

## ğŸ¯ å¯¦é©—ç’°å¢ƒ

  * **ç›®æ¨™è»Ÿé«”**: QEMU
  * **ç‰ˆæœ¬**: 2.6.0 (æˆ– 2.6.0-rc2)
  * **ç›®æ¨™è¨­å‚™**: `virtio-scsi-pci`
  * **Guest OS**: Linux (Ubuntu 16.04)
  * **Host OS**: Linux (Ubuntu)

## ğŸ“„ ç¨‹å¼ç¢¼åˆ†æ (`exploit.c`)

è©²ç¨‹å¼ç¢¼æ˜¯ä¸€å€‹ Linux æ ¸å¿ƒæ¨¡çµ„ï¼Œå› ç‚ºåªæœ‰åœ¨ Kernel Mode ä¸‹æ‰èƒ½ç›´æ¥æ“ä½œ I/O Port èˆ‡ç‰©ç†è¨˜æ†¶é«”åœ°å€ï¼Œé€™æ˜¯èˆ‡ç¡¬é«”äº¤äº’çš„å¿…è¦æ¢ä»¶ã€‚ç¨‹å¼ä¸»è¦åŸ·è¡Œæµç¨‹å¦‚ä¸‹ï¼š

1.  **å®šç¾© Virtio æ•¸æ“šçµæ§‹**:

      * å®šç¾©äº† `vring_desc` (æè¿°ç¬¦) å’Œ `vring_avail` (å¯ç”¨ç’°) çµæ§‹é«”ï¼Œé€™æ˜¯ Virtio å”è­°é€šè¨Šçš„åŸºç¤ã€‚
      * å®šç¾©äº† Virtio SCSI çš„é è¨­ I/O Port åŸºå€ (`0xc040`) åŠç›¸é—œæš«å­˜å™¨åç§»é‡ (`PFN`, `SEL`, `NOTIFY`)ã€‚

2.  **åˆ†é…èˆ‡åˆå§‹åŒ–è¨˜æ†¶é«”**:

      * ä½¿ç”¨ `kmalloc` åˆ†é…ä¸€å¡Šé€£çºŒçš„ç‰©ç†è¨˜æ†¶é«” (`0x3000` bytes) ä¾†æ¨¡æ“¬ Virtqueueã€‚
      * ä½¿ç”¨ `virt_to_phys` å°‡è™›æ“¬åœ°å€è½‰æ›ç‚ºç‰©ç†åœ°å€ï¼Œå› ç‚º QEMU (Host) åªèªå¾—ç‰©ç†åœ°å€ã€‚

3.  **æ§‹é€ æƒ¡æ„ Payload (é—œéµæ”»æ“Šé»)**:

      * **æ­£å¸¸æè¿°ç¬¦ (`desc[0]`)**: è¨­ç½®æ¨™èªŒä½ `VRING_DESC_F_NEXT`ï¼ŒæŒ‡å‘ä¸‹ä¸€å€‹æè¿°ç¬¦ã€‚
      * **æƒ¡æ„æè¿°ç¬¦ (`desc[1]`)**:
          * è¨­ç½®æ¨™èªŒä½ `VRING_DESC_F_WRITE`ã€‚
          * **æº¢å‡ºæ”»æ“Š**: å°‡é•·åº¦ `len` è¨­å®šç‚ºç•°å¸¸å·¨å¤§çš„æ•¸å€¼ (`0x44444444`)ã€‚
      * é€™å€‹ç•°å¸¸é•·åº¦æ—¨åœ¨è§¸ç™¼ QEMU å…§éƒ¨ `cpu_physical_memory_map` æˆ–ç›¸é—œå‡½æ•¸çš„éŒ¯èª¤ï¼Œä½¿å…¶è¿”å›ç©ºæŒ‡æ¨™ (NULL) æˆ–é€ æˆæ•´æ•¸æº¢å‡ºã€‚

4.  **è§¸ç™¼é€šçŸ¥æ©Ÿåˆ¶ (Trigger)**:

      * è¨­ç½® `avail->idx` èˆ‡ `avail->ring`ï¼Œå°‡æƒ¡æ„æè¿°ç¬¦éˆæ”¾å…¥ä½‡åˆ—ã€‚
      * é€é `outw` å’Œ `outl` æŒ‡ä»¤ç›´æ¥å¯«å…¥ I/O Portã€‚
      * **æœ€å¾Œä¸€æ“Š**: å¯«å…¥ `VIRTIO_PCI_QUEUE_NOTIFY` ç«¯å£ï¼Œå¼·è¿« QEMU è™•ç†ä¸Šè¿°æƒ¡æ„æ•¸æ“šã€‚

## ğŸš€ ä½¿ç”¨æ­¥é©Ÿ

### 1\. å•Ÿå‹• QEMU (Host ç«¯)

å‹™å¿…å•Ÿç”¨ `virtio-scsi-pci` è¨­å‚™ä¸¦é–‹å•Ÿ KVM æ”¯æ´ã€‚

```bash
./qemu-2.6.0/x86_64-softmmu/qemu-system-x86_64 \
  -enable-kvm \
  -m 2048 \
  -hda vir1.img \
  -device virtio-scsi-pci \
  -net user,hostfwd=tcp::2222-:22 \
  -net nic \
  -cdrom ./ubuntu-16.04.7-server-amd64.iso
```

### 2\. ç·¨è­¯æ”»æ“Šæ¨¡çµ„ (Guest ç«¯)

åœ¨è™›æ“¬æ©Ÿå…§éƒ¨ï¼Œä½¿ç”¨ `Makefile` ç·¨è­¯ `exploit.c`ã€‚

```bash
make
# æˆåŠŸå¾Œæœƒç”Ÿæˆ exploit.ko
```

### 3\. åŸ·è¡Œæ”»æ“Š (Guest ç«¯)

è¼‰å…¥æ ¸å¿ƒæ¨¡çµ„ä»¥è§¸ç™¼æ¼æ´ã€‚

```bash
sudo insmod exploit.ko
```

### 4\. è§€å¯Ÿçµæœ

  * **Guest ç«¯**: çµ‚ç«¯æ©Ÿå¯èƒ½æœƒå¡ä½ã€‚
  * **Host ç«¯**: QEMU é€²ç¨‹å°‡æœƒå´©æ½°ä¸¦é¡¯ç¤º `Segmentation fault (core dumped)`ã€‚
  * **GDB èª¿è©¦**: è‹¥æ›è¼‰ GDBï¼Œå¯è§€å¯Ÿåˆ°å´©æ½°é»ä½æ–¼ `virtio_scsi_handle_cmd` è™•ç†æµç¨‹ä¸­ï¼Œé€šå¸¸æ¶‰åŠç©ºæŒ‡æ¨™å¼•ç”¨ (Null Pointer Dereference)ã€‚

## âš ï¸ å…è²¬è²æ˜

è«‹å‹¿åœ¨æœªç¶“æˆæ¬Šçš„ç”Ÿç”¢ç’°å¢ƒä¸­ä½¿ç”¨ã€‚

